<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthvoice - Medical Transcription & Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        [x-cloak] {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gradient-to-br from-medical-50 to-blue-50 min-h-screen text-slate-800" x-data="app()">

    <nav class="fixed top-0 w-full z-50 glass-panel shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" @click="page = 'home'">
                    <div
                        class="w-8 h-8 bg-medical-500 rounded-lg flex items-center justify-center text-white font-bold">
                        H</div>
                    <span class="font-bold text-xl tracking-tight text-medical-900">Healthvoice</span>
                </div>
                <div class="flex gap-6">
                    <button @click="page = 'home'"
                        :class="page === 'home' ? 'text-medical-600 font-bold' : 'text-slate-500 hover:text-medical-500'"
                        class="transition">Home</button>
                    <button @click="navigate('transcript')"
                        :class="page === 'transcript' ? 'text-medical-600 font-bold' : 'text-slate-500 hover:text-medical-500'"
                        class="transition">Transkrip</button>
                    <button @click="navigate('dashboard')"
                        :class="page === 'dashboard' ? 'text-medical-600 font-bold' : 'text-slate-500 hover:text-medical-500'"
                        class="transition">Dashboard</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-20 pb-10 px-4 max-w-7xl mx-auto">

        <div x-show="page === 'home'" x-transition.opacity.duration.500ms
            class="flex flex-col items-center justify-center min-h-[80vh] text-center space-y-8 fade-in">
            <h1 class="text-5xl md:text-7xl font-bold text-slate-900 tracking-tight">
                Rekam Medis,<br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-medical-500 to-teal-500">Lebih
                    Cerdas.</span>
            </h1>
            <p class="text-xl text-slate-600 max-w-2xl leading-relaxed">
                Healthvoice membantu tenaga medis menstranskrip wawancara pasien TB (Ibu & Balita) dan mencari informasi
                krusial menggunakan AI canggih.
            </p>

            <div class="flex gap-4">
                <button @click="navigate('transcript')"
                    class="bg-medical-600 hover:bg-medical-700 text-white px-8 py-4 rounded-full font-semibold shadow-lg shadow-medical-500/30 transition transform hover:scale-105 flex items-center gap-2">
                    <span>Mulai Transkrip</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
                <button @click="showTutorial = true"
                    class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-8 py-4 rounded-full font-semibold shadow-sm transition">
                    Cara Pakai
                </button>
            </div>

            <div x-show="showTutorial"
                class="mt-8 p-6 bg-white rounded-2xl shadow-xl border border-slate-100 max-w-3xl text-left"
                @click.outside="showTutorial = false">
                <h3 class="font-bold text-lg mb-4">Cara Penggunaan:</h3>
                <ol class="list-decimal list-inside space-y-2 text-slate-600">
                    <li>Masuk ke menu <strong>Transkrip</strong>.</li>
                    <li>Upload file audio (.wav/.mp3) atau rekam langsung.</li>
                    <li>Sistem akan memproses (Whisper Medium Model).</li>
                    <li>Buka <strong>Dashboard</strong> untuk melihat hasil & download.</li>
                    <li>Gunakan fitur <strong>Pencarian Cerdas</strong> untuk bertanya pada dokumen.</li>
                </ol>
            </div>
        </div>

        <div x-show="page === 'transcript'" x-cloak x-transition.opacity class="fade-in space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold">Transcription Center</h2>
                <p class="text-slate-500">Upload atau rekam sesi tanya jawab medis.</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">

                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-slate-400 dashed-border relative hover:border-medical-500 transition group"
                    @dragover.prevent="dragover = true" @dragleave.prevent="dragover = false"
                    @drop.prevent="handleDrop($event);">

                    <input type="file" x-ref="fileInput" class="hidden" @change="handleFile($event.target.files[0])"
                        accept=".wav,.mp3,.m4a">

                    <div
                        class="w-16 h-16 bg-slate-50 group-hover:bg-medical-50 rounded-full flex items-center justify-center mb-4 transition">
                        <svg class="w-8 h-8 text-slate-400 group-hover:text-medical-500" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <p class="font-medium text-slate-600">Drag & Drop file audio</p>
                    <p class="text-sm">atau <button @click="$refs.fileInput.click()"
                            class="text-medical-600 font-bold hover:underline">cari file</button></p>

                    <div x-show="uploading"
                        class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center rounded-3xl">
                        <div
                            class="w-8 h-8 border-4 border-medical-500 border-t-transparent rounded-full animate-spin mb-2">
                        </div>
                        <span class="text-medical-700 font-bold">Uploading...</span>
                    </div>
                </div>

                <div
                    class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center justify-center relative">
                    <div x-show="!isRecording && !recordedBlob">
                        <button @click="startRecording"
                            class="w-20 h-20 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center shadow-lg shadow-red-500/30 transition transform hover:scale-110">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        </button>
                        <p class="mt-4 font-medium text-center text-slate-600">Klik untuk Rekam</p>
                    </div>

                    <div x-show="isRecording" class="text-center">
                        <div
                            class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4 animate-pulse">
                            <div class="w-12 h-12 bg-red-500 rounded-full"></div>
                        </div>
                        <p class="text-red-500 font-mono text-xl" x-text="formatTimer(recordingTime)"></p>
                        <button @click="stopRecording"
                            class="mt-4 px-6 py-2 bg-slate-800 text-white rounded-full text-sm">Stop Recording</button>
                    </div>

                    <div x-show="recordedBlob && !isRecording" class="w-full space-y-4">
                        <audio x-ref="audioPreview" controls class="w-full"></audio>
                        <input type="text" x-model="recordingName" placeholder="Nama file (cth: Pasien A)"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 ring-medical-500 outline-none">
                        <div class="flex gap-2">
                            <button @click="saveRecording(false)"
                                class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200">Simpan
                                Saja</button>
                            <button @click="saveRecording(true)"
                                class="flex-1 px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 shadow-md">Transkrip!</button>
                        </div>
                        <button @click="resetRecorder"
                            class="text-sm text-red-500 hover:underline w-full text-center">Batal / Ulang</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-amber-400 rounded-full"></span> Antrian & Proses
                </h3>

                <template x-if="recentTranscripts.length === 0">
                    <p class="text-slate-400 text-sm">Belum ada file yang diproses.</p>
                </template>

                <div class="space-y-4">
                    <template x-for="item in recentTranscripts" :key="item.id">
                        <div class="border rounded-xl p-4 flex items-center justify-between"
                            :class="item.status === 'processing' ? 'border-medical-200 bg-medical-50' : 'border-slate-100'">
                            <div>
                                <h4 class="font-semibold text-slate-800" x-text="item.filename"></h4>
                                <p class="text-sm text-slate-500" x-text="item.current_step"></p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold px-2 py-1 rounded full uppercase" :class="{
                                        'bg-gray-100 text-gray-600': item.status === 'pending',
                                        'bg-slate-100 text-slate-600': item.status === 'queued',
                                        'bg-blue-100 text-blue-600': item.status === 'processing',
                                        'bg-green-100 text-green-600': item.status === 'completed',
                                        'bg-red-100 text-red-600': item.status === 'error'
                                      }" x-text="item.status"></span>

                                <template x-if="item.status === 'pending'">
                                    <button @click="startItem(item.id)"
                                        class="text-xs bg-medical-500 hover:bg-medical-600 text-white px-3 py-1 rounded-full shadow-sm font-bold transition mt-1 block">Start
                                        Transkrip</button>
                                </template>

                                <div x-show="item.status === 'error'">
                                    <button @click="retryItem(item.id)"
                                        class="text-xs text-blue-500 hover:underline mt-1">Retry</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div x-show="page === 'dashboard'" x-cloak x-transition.opacity class="fade-in space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold">Dashboard</h2>
                    <p class="text-slate-500">Arsip transkrip dan Analisis AI.</p>
                </div>
                <button @click="fetchTranscripts" class="text-medical-600 hover:bg-medical-50 p-2 rounded-full"><svg
                        class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg></button>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <div
                    class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 lg:col-span-1 h-[80vh] overflow-y-auto">
                    <h3 class="font-bold text-slate-400 mb-4 text-xs uppercase tracking-wider">File Transkrip</h3>
                    <div class="space-y-2">
                        <template x-for="item in transcripts" :key="item.id">
                            <div @click="selectTranscript(item)" class="p-4 rounded-xl cursor-pointer transition border"
                                :class="selectedTranscript && selectedTranscript.id === item.id ? 'bg-medical-50 border-medical-500 ring-1 ring-medical-500' : 'bg-white border-slate-100 hover:border-medical-300'">
                                <h4 class="font-bold text-slate-800 truncate" x-text="item.filename"></h4>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-slate-400"
                                        x-text="new Date(item.upload_date).toLocaleDateString()"></span>
                                    <span class="text-xs px-2 py-0.5 rounded-full"
                                        :class="item.status === 'completed' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'"
                                        x-text="item.status"></span>

                                    <button @click.stop="deleteItem(item.id)"
                                        class="text-slate-300 hover:text-red-500 transition px-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div x-show="!selectedTranscript"
                        class="h-full flex flex-col items-center justify-center text-slate-300 border-2 border-dashed border-slate-200 rounded-3xl p-10">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>Pilih file di sebelah kiri untuk melihat detail.</p>
                    </div>

                    <template x-if="selectedTranscript">
                        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                            <div
                                class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800" x-text="selectedTranscript.filename">
                                    </h2>
                                    <p class="text-slate-500 text-sm mt-1">Diproses: <span
                                            x-text="new Date(selectedTranscript.upload_date).toLocaleString()"></span>
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <a :href="'/api/transcripts/' + selectedTranscript.id + '/download_text'"
                                        target="_blank"
                                        class="px-4 py-2 text-sm bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 font-medium transition">Download
                                        Teks</a>
                                    <button @click="downloadQA()"
                                        class="px-4 py-2 text-sm bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg font-medium transition flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        Download Word
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-lg mb-4 text-medical-700">Pencarian Cerdas (AI)</h3>

                                <div class="space-y-3 mb-6">
                                    <template x-for="(q, idx) in questionList" :key="idx">
                                        <div class="flex gap-2">
                                            <input type="text" x-model="questionList[idx]"
                                                placeholder="Tulis keprihatinan pasien..."
                                                class="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:border-medical-500 outline-none transition bg-slate-50">
                                            <button @click="questionList.splice(idx, 1)"
                                                class="text-slate-400 hover:text-red-500 px-2"
                                                x-show="questionList.length > 1">&times;</button>
                                        </div>
                                    </template>
                                    <div class="flex gap-2 mt-2">
                                        <button @click="questionList.push('')"
                                            class="text-sm text-medical-600 font-semibold hover:underline">+ Tambah
                                            Pertanyaan</button>
                                        <div class="flex-1"></div>
                                        <button @click="submitQuestions"
                                            class="bg-medical-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-medical-500/20 hover:bg-medical-700 transition">Cari
                                            Jawaban</button>
                                    </div>
                                </div>

                                <div x-show="qaLoading" class="mb-4">
                                    <div class="w-full bg-slate-100 rounded-full h-2 mb-2 overflow-hidden">
                                        <div class="bg-medical-500 h-2 rounded-full animate-pulse w-full"></div>
                                    </div>
                                    <p class="text-xs text-slate-500 text-center">AI sedang membaca dokumen & mencari
                                        jawaban...</p>
                                </div>

                                <div class="space-y-4">
                                    <template x-for="qa in qaResults" :key="qa.id">
                                        <div class="border border-slate-100 rounded-2xl p-5 bg-slate-50">
                                            <div class="flex justify-between items-start mb-2">
                                                <p class="font-bold text-slate-800">Q: <span
                                                        x-text="qa.question"></span></p>
                                                <button @click="deleteQA(qa.id)"
                                                    class="text-slate-300 hover:text-red-500 ml-2"
                                                    title="Hapus Pertanyaan">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                        </path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="prose prose-sm text-slate-600">
                                                <template x-if="qa.status === 'completed'">
                                                    <div>
                                                        <p class="mb-3" x-text="qa.answer"></p>
                                                        <div
                                                            class="bg-white p-3 rounded-lg border border-slate-200 text-xs text-slate-400 italic">
                                                            <strong class="block mb-1 not-italic text-slate-500">Konteks
                                                                dari Transkrip:</strong>
                                                            <span
                                                                x-text="qa.context_used ? qa.context_used.substring(0, 300) + '...' : 'Tidak ada konteks'"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <template x-if="qa.status === 'processing' || qa.status === 'queued'">
                                                    <p class="text-blue-500 italic">Sedang berpikir...</p>
                                                </template>
                                                <template x-if="qa.status === 'error'">
                                                    <p class="text-red-500 x-text=" qa.answer"></p>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-lg mb-4">Isi Transkrip</h3>
                                <div
                                    class="max-h-64 overflow-y-auto p-4 bg-slate-50 rounded-xl text-sm text-slate-600 leading-relaxed font-mono">
                                    <p x-text="selectedTranscript.raw_text || 'Teks belum tersedia.'"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </main>

    <script src="app.js"></script>
</body>

</html>